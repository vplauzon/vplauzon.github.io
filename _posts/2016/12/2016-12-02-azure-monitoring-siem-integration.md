---
title:  Azure Monitoring - SIEM integration
date:  2016-12-02 12:13:34 -05:00
permalink:  "/2016/12/02/azure-monitoring-siem-integration/"
categories:
- Solution
tags:  []
---
<p><a href="http://vincentlauzon.files.wordpress.com/2016/12/pexels-photo-966121.jpg"><img title="Security cameras" style="background-image:none;float:right;padding-top:0;padding-left:0;display:inline;padding-right:0;border-width:0;" border="0" alt="Security cameras" src="http://vincentlauzon.files.wordpress.com/2016/12/pexels-photo-966121_thumb.jpg" width="640" align="right" height="427"/></a>Quite a few of my customers have a <em><a href="https://en.wikipedia.org/wiki/Security_information_and_event_management" target="_blank">Security Information and Event Management</a></em> (SIEM) on premise.&nbsp; They spent thousands of dollars fine tuning it to detect and correlate security events, it’s integrated with their ticketing system, but mostly…&nbsp; it has been <strong>sanctioned</strong> as the corporate security tool.</p> <p>So the next question is:&nbsp; how do I integrate that with Azure resources?</p> <h2>Azure Monitoring</h2> <p>In the <a href="https://vincentlauzon.com/2016/11/27/primer-on-azure-monitor/">last post</a>, I talked about Azure Monitor, the consolidated Azure monitoring platform.&nbsp; If you haven’t read it and do not know what Azure Monitor is, <a href="https://vincentlauzon.com/2016/11/27/primer-on-azure-monitor/">go read it</a>, I’ll wait for you here.</p> <p>Either by itself, for medium deployment, or by upgrading to <a href="https://vincentlauzon.com/2016/11/27/primer-on-azure-monitor/" target="_blank">Log Analytics</a> (part of <a href="https://docs.microsoft.com/en-us/azure/operations-management-suite/operations-management-suite-overview" target="_blank">OMS</a>) for more complex or bigger deployments, we can monitor a solution or set of solutions.</p> <p>By monitoring, I mean that we can have insights about what’s going on within our solutions, for instance:</p> <ul> <li>Have any failures occurred or are currently occurring?  </li><li>What is the current and past load?  </li><li>Are resources well utilized or do we have under / over provisioning?</li></ul> <p>…&nbsp; and so on.&nbsp; This doesn’t address a lot of security requirements, such as treat detection, though.</p> <h2>Security Center</h2> <p>For a customer who do not have a legacy SIEM in place, I would recommend to take a look at <a href="https://vincentlauzon.com/2016/11/27/primer-on-azure-monitor/" target="_blank">Security Center</a>.&nbsp; It is a solid base for security monitoring and takes minutes to setup.</p> <p>Security Center does threat detection and correlation between security events.</p> <h2>Microsoft Azure Log Integration</h2> <p>Back to my legacy SIEM scenario.</p> <p>In July 2016, <a href="https://blogs.msdn.microsoft.com/azuresecurity/2016/07/21/microsoft-azure-log-integration-preview/" target="_blank">Microsoft released Microsoft Azure Log Integration</a>.&nbsp; As of November 2016, it is still in Preview.</p> <p>You can download the tool at <a title="https://aka.ms/azlogdownload" href="https://aka.ms/azlogdownload">https://aka.ms/azlogdownload</a>.&nbsp; It is meant to be installed on a VM along standard SIEM connector agent (e.g. <a href="https://www.splunk.com/en_us/download/universal-forwarder.html" target="_blank">Splunk Universal Forwarder</a>, <a href="http://www.hp.com/hpinfo/newsroom/press_kits/2013/HPDiscover2013/Datasheet_ArcSight_Connectors.pdf" target="_blank">ArcSight Windows Event Collector agent</a> or <a href="http://www-01.ibm.com/support/docview.wss?uid=swg27045054" target="_blank">Qradar wincollect</a>).&nbsp; The VM is meant to act as a log gateway:&nbsp; it collects logs from Storage Accounts and send them to the SIEM via standard SIEM connector.</p> <p><a href="http://vincentlauzon.files.wordpress.com/2016/12/highlevelarchazlog11.png"><img title="From https://blogs.msdn.microsoft.com/azuresecurity/2016/07/21/microsoft-azure-log-integration-preview/" style="border-top:0;border-right:0;background-image:none;border-bottom:0;padding-top:0;padding-left:0;border-left:0;display:inline;padding-right:0;" border="0" alt="From https://blogs.msdn.microsoft.com/azuresecurity/2016/07/21/microsoft-azure-log-integration-preview/" src="http://vincentlauzon.files.wordpress.com/2016/12/highlevelarchazlog1_thumb1.png" width="640" height="152"/></a></p> <p align="left">A complete guide to set this up is available <a href="https://azsiempublicdrops.blob.core.windows.net/drops/Azure%20SIEM%20Integrator%20User%20Guide.pdf" target="_blank">here</a>.</p> <p align="left">Of course, this setup assume we are exporting all the logs to Azure Storage.</p> <h2 align="left">Networking considerations</h2> <p align="left">Now that we’ve looked at the general solution, let’s consider where the different components could reside since as with all things depending on a pesky thing called physics, latency matter.</p> <p align="left">Following the diagram from previous section from left to right, the Azure resources &amp; Azure storage are, of course, in Azure.&nbsp; The VM running the Log Integration could be either in Azure or on Premise so can our SIEM.&nbsp; So let’s consider the different possibilities.</p> <h3>Log Integration &amp; SIEM on premise</h3> <p>In many ways, that might be the easiest way to install the log integration but also most likely the less efficient.</p> <p>It is easy because you simply need a VM on premise with access to the SIEM and the internet, in order to access Azure Storage.</p> <p>It is likely inefficient because of the latency between on premise site and Azure.&nbsp; The Log Integration tool will probe different parts of Azure Storage at regular intervals with and the latency will build up.&nbsp; Network bandwidth, which do not come for free on premise, will also add up.</p> <p>For many Azure resources with verbose logs, the network bandwidth requirement might be so demanding that connecting over the internet is too slow or unreliable, in which case we would consider <a href="https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction" target="_blank">Azure Express Route</a>.</p> <h3>Log Integration in Azure &amp; SIEM on premise</h3> <p>This setup is slightly less straightforward because of hybrid connectivity.&nbsp; Indeed, the Log Integration VM, being in Azure, needs some hybrid connectivity in order to communicate with the on premise SIEM.</p> <p>This can easily be achieved with a site-to-site connection through an <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices" target="_blank">Azure VPN Gateway</a>.</p> <p><a href="http://vincentlauzon.files.wordpress.com/2016/12/image.png"><img title="image" style="border-top:0;border-right:0;background-image:none;border-bottom:0;padding-top:0;padding-left:0;border-left:0;display:inline;padding-right:0;" border="0" alt="image" src="http://vincentlauzon.files.wordpress.com/2016/12/image_thumb.png" width="602" height="480"/></a></p> <p>This setup is likely going to be more efficient network wise since all Azure Storage probing will occur in Azure with no bandwidth on premise.&nbsp; Only the gathered logs shipped on premise to the SIEM will incur bandwidth.</p> <p>This can still be a lot if we have a few resources in Azure and gather verbose logs.&nbsp; Again Express Route could be considered.</p> <h3>Log Integration &amp; SIEM in Azure</h3> <p>In this scenario, we migrate the SIEM in Azure.&nbsp; Bam!&nbsp; No more latency.</p> <p>Unless we also moved all on premise workload in Azure we now have the reverse problem we had, i.e. we need to push on premise logs to Azure.</p> <p>A variant on that scenario actually brings the best of both worlds.</p> <h3>Azure SIEM to generate security events</h3> <p>In this scenario, we install a SIEM in Azure while also keeping the one we have on premise.</p> <p><a href="http://vincentlauzon.files.wordpress.com/2016/12/image1.png"><img title="image" style="border-top:0;border-right:0;background-image:none;border-bottom:0;padding-top:0;padding-left:0;border-left:0;display:inline;padding-right:0;" border="0" alt="image" src="http://vincentlauzon.files.wordpress.com/2016/12/image_thumb1.png" width="640" height="424"/></a></p> <p>The one in Azure acts as an aggregator of logs and generates security events.&nbsp; Only those security events are shipped to the SIEM on premise.&nbsp; This reduces the network pipe requirement considerably but still achieve the same goal, i.e. for the “main SIEM” to have enough information to be able to correlate security events from different sources in order to detect attack patterns.</p> <p>A blocker for this approach would obviously be the license costs to install a SIEM in Azure.&nbsp; I wouldn’t recommend this for a small deployment.</p> <p>If workload migration is happening from on premise to Azure, as a corporate strategy for instance, we could consider inversing the SIEM at some point, i.e. having the main SIEM in Azure and an aggregator one on premise.&nbsp; This could make sense early on since storage is cheaper in the cloud than on premise and SIEM tends to consume lots of those.&nbsp; Also, a SIEM being a critical system, it tends to be easier / cheaper to have an high SLA in Azure than on premise.</p> <h2>Summary</h2> <p>Azure Log Integration with on premise SIEM is often a corporate requirement.&nbsp; In this article we went through the solution and some variants regarding networking consideration.</p>