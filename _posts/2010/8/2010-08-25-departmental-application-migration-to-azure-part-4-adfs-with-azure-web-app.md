---
title:  Departmental Application Migration to Azure – Part 4 – ADFS with Azure web app
date:  08/25/2010 17:31:30
permalink:  "/2010/08/25/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/"
categories:
- Solution
tags:
- Security
---
<p>This is part of a series of blogs.&#160; See the preceding blog entries:</p>  <ul>   <li><a href="http://vincentlauzon.wordpress.com/2010/06/02/departmental-application-migration-to-azure-part-1/">Departmental Application Migration to Azure – Part 1</a> </li>    <li><a href="http://vincentlauzon.wordpress.com/2010/06/02/departmental-application-migration-to-azure-part-2-adfs-installation/">Departmental Application Migration to Azure – Part 2 – ADFS Installation</a> </li>    <li><a href="http://vincentlauzon.wordpress.com/2010/07/15/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/">Departmental Application Migration to Azure – Part 3 – ADFS with on-premise web app</a> </li> </ul>  <p>As mentioned <a href="http://vincentlauzon.wordpress.com/2010/07/15/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/">before</a> on this blog series, for me the authentication is the major challenge for this proof of concept.&#160; I need this web application to support Enterprise Single Sign-On through Active Directory.&#160; I’ve decided to use ADFS 2.0 and Windows Identity Foundation (WIF).&#160; In the last article, I’ve showed how to get an on-premise web application using ADFS for authentication.&#160; On this blog entry, I’m going to the cloud, so let’s get started!</p>  <h3>Prerequisites</h3>  <p>You need to have ADFS 2.0 installed.&#160; This was covered in a <a href="http://vincentlauzon.wordpress.com/2010/06/02/departmental-application-migration-to-azure-part-2-adfs-installation/">previous blog entry</a> from this series.</p>  <p>You’ll also need the Windows Identity Foundation (WIF) SDK.&#160; You can download it at <a href="http://www.microsoft.com/downloads/details.aspx?familyid=C148B2DF-C7AF-46BB-9162-2C9422208504&amp;displaylang=en">http://www.microsoft.com/downloads/details.aspx?familyid=C148B2DF-C7AF-46BB-9162-2C9422208504&amp;displaylang=en</a>.</p>  <p>You’ll also need the Windows Azure SDK.&#160; I’m using the one from June 2010, you can download it at <a title="http://www.microsoft.com/downloads/details.aspx?familyid=21910585-8693-4185-826E-E658535940AA&amp;displaylang=en" href="http://www.microsoft.com/downloads/details.aspx?familyid=21910585-8693-4185-826E-E658535940AA&amp;displaylang=en">http://www.microsoft.com/downloads/details.aspx?familyid=21910585-8693-4185-826E-E658535940AA&amp;displaylang=en</a>.</p>  <p>To top it all, you can install the Windows Azure Tools for Microsoft Visual Studio 1.2 (also from June 2010).&#160; You can download it at <a title="http://www.microsoft.com/downloads/details.aspx?familyid=2274A0A8-5D37-4EAC-B50A-E197DC340F6F&amp;displaylang=en" href="http://www.microsoft.com/downloads/details.aspx?familyid=2274A0A8-5D37-4EAC-B50A-E197DC340F6F&amp;displaylang=en">http://www.microsoft.com/downloads/details.aspx?familyid=2274A0A8-5D37-4EAC-B50A-E197DC340F6F&amp;displaylang=en</a>.</p>  <p>I’ll use Visual Studio 2010.</p>  <h3>Creating a web role in Dev Fabric</h3>  <p>Let’s start by creating a vanilla web role in Dev Fabric.&#160; The Dev Fabric is the dev environment provided with the Windows Azure SDK, basically, the developer work station.</p>  <p>I start by creating an empty solution which I name <em>AdfsAuthenticatedAzure</em>.</p>  <p>I then create a Windows Azure Cloud Service named <em>MyCloudFacade</em>.</p>  <p><a href="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image5.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image_thumb5.png" width="644" height="446" /></a> </p>  <p>A Cloud service is a unit of deployment.&#160; A service contains different roles and a configuration for the service.&#160; The roles are all deployed together in one package.</p>  <p>I create one role within that service, a web role named AdfsAuthenticatedWebRole.</p>  <p><a href="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image6.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image_thumb6.png" width="554" height="354" /></a></p>  <p>Like the solution on-premise I did in the last blog entry, I’m trimming the boiler-plate web project:</p>  <ul>   <li>Delete the <em>Account</em> folder since ADFS will perform those functions. </li>    <li>In web.config:      <ul>       <li>Delete the <em>connection</em> string. </li>        <li>Delete the <em>authentication</em> xml node. </li>        <li>Delete the <em>membership</em> xml node. </li>        <li>Delete the <em>profile</em> xml node. </li>        <li>Delete the <em>roleManager</em> xml node. </li>     </ul>   </li> </ul>  <p>I can now hit F5 and look at my wonderful generic web site!</p>  <h3>Deploying to Azure</h3>  <p>To integrate with ADFS, I’ll need my web site to be using SSL.&#160; I’ll attach a certificate to my service and enable an https input endpoint.&#160; I’ll start at the properties of my web role.</p>  <p><a href="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image7.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image_thumb7.png" width="394" height="176" /></a> </p>  <p>At the <em>certificates</em> tab:</p>  <p><a href="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image8.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image_thumb8.png" width="140" height="211" /></a></p>  <p>I then add a certificate and select one of my local (self-issued) certificates.</p>  <p><a href="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image9.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image_thumb9.png" width="748" height="161" /></a> </p>  <p>I then go at the <em>Endpoints</em> tab, check the HTTPS check box and select the SSL certificate name I just added.</p>  <p><a href="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image10.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image_thumb10.png" width="491" height="229" /></a> </p>  <p>The Windows Azure Tools for Microsoft Visual Studio 1.2 allow you to deploy to Azure directly, instead of simply packaging (where you have to deploy the package using the web console).&#160; There are plenty of web resources showing how to deploy an Azure service to the cloud.&#160; If you have questions, please ask.</p>  <p>While it’s deploying, I’ll add the same certificate to my service in the cloud.&#160; In my Azure Service Web console:</p>  <p><a href="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image11.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image_thumb11.png" width="644" height="56" /></a> </p>  <p>I need a PFX file to upload.&#160; I use IIS Server Certificates module and export the same self-issued certificate I used in Visual Studio.</p>  <p><a href="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image12.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image_thumb12.png" width="644" height="353" /></a></p>  <p>I can then save the certificate locally and protect it with a password.&#160; I can then import it in the Azure web console, using the same password.</p>  <p>I first deploy to staging then to production.&#160; As I mentioned in a <a href="http://vincentlauzon.wordpress.com/2010/08/12/dev-staging-production-in-windows-azure/">previous blog entry</a>, staging isn’t a real staging as Microsoft recommend to have a separate subscription altogether for staging vs production.&#160; This is important here, since staging would be harder to integrate with ADFS given its unpredictable URL (Azure generates staging URLs using a GUID).</p>  <p>Of course I get warnings because my certificate is self-issued and hence unrecognized by IE as trustworthy.</p>  <h3>Integrating ADFS in Dev Fabric</h3>  <p>The steps here are a repetition of what I covered in the <a href="http://vincentlauzon.wordpress.com/2010/07/15/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/">previous blob entry of this series</a>, so I won’t go into much details.</p>  <p>First, I choose to <em>Add STS Reference</em> and set <a href="https://localhost:444">https://localhost:444</a>.</p>  <p><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image13.png" width="644" height="484" /> </p>  <p>(The https in-point port is set to 443, which is the default https port, but this port being used by IIS, the web role responds to port 443 in the dev environment)</p>  <p>For the rest of the Wizard, it’s the same steps I used in the <a href="http://vincentlauzon.wordpress.com/2010/07/15/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/">precedent blog</a> of this blog series.</p>  <p>I then run the modified web role in my dev environment.&#160; I get an error from the ADFS site since my application isn’t recognized there yet.&#160; So in the ADFS console, I create a relying trust party named <em>Adfs Authenticated Dev</em>.&#160; The reason I append the name by dev is that we’ll need to create an entry for the production endpoint as well, since it has a different URL.&#160; In the claims rules, I make sure ADFS will send me a few claims (e.g. windows name, email, title, etc.).</p>  <p>I can now use my local web role, after doing the form validation fix I spoke about <a href="http://vincentlauzon.wordpress.com/2010/07/15/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/">last time</a>.&#160; I also remove the HTTP input endpoint since ADFS will only trust me if I come from HTTPS.&#160; Finally, I add a grid view showing all the user claims like I did last time.</p>  <h3>Integrating ADFS with Azure</h3>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p>I then run the <em>Add STS Reference</em> in Visual Studio again.&#160; This time I use my production Windows Azure URL (<a href="https://****.cloudapp.net">https://****.cloudapp.net</a>).&#160; I then go in the federation metadata file and remove reference to localhost:</p>  <p><font face="Courier New">&lt;EndpointReference xmlns=&quot;</font><a href="http://www.w3.org/2005/08/addressing&quot;"><font face="Courier New">http://www.w3.org/2005/08/addressing&quot;</font></a><font face="Courier New">&gt;      <br />&#160;&#160;&#160; &lt;Address&gt;</font><a href="https://localhost:444/"><font face="Courier New">https://localhost:444/</font></a><font face="Courier New">&lt;/Address&gt;      <br />&lt;/EndpointReference&gt; </font></p>  <p>After this, my meta isn’t usable for dev, but I only need to maintain it for production.</p>  <p>I run the ADFS relying party trust wizard again, still pointing to that meta data file.&#160; I call this party <em>Adfs Authenticated Prod</em>.</p>  <p>The problem I’ll run into now is that the w-reply query string will forward me to my production web role.&#160; This is related to how WIF is creating the URL to the STS.&#160; It uses a URL specified in the configuration file.&#160; The fix for this is documented in the Windows Azure training kit:&#160; override the query string using the WS-Federation authentication module by adding the following code in the <em>Global.asax</em>.</p>  <p><font face="Courier New">/// &lt;summary&gt;      <br />/// Retrieves the address that was used in the browser for accessing       <br />/// the web application, and injects it as WREPLY parameter in the       <br />/// request to the STS       <br />/// &lt;/summary&gt;       <br />void WSFederationAuthenticationModule_RedirectingToIdentityProvider(object sender, RedirectingToIdentityProviderEventArgs e)       <br />{       <br />&#160;&#160;&#160; //       <br />&#160;&#160;&#160; // In the Windows Azure environment, build a wreply parameter for&#160; the SignIn request       <br />&#160;&#160;&#160; // that reflects the real address of the application.       <br />&#160;&#160;&#160; //       <br />&#160;&#160;&#160; HttpRequest request = HttpContext.Current.Request;       <br />&#160;&#160;&#160; Uri requestUrl = request.Url;       <br />&#160;&#160;&#160; StringBuilder wreply = new StringBuilder(); </font></p>  <p><font face="Courier New">&#160;&#160;&#160; wreply.Append(requestUrl.Scheme);&#160;&#160;&#160;&#160; // e.g. &quot;http&quot; or &quot;https&quot;      <br />&#160;&#160;&#160; wreply.Append(&quot;://&quot;);       <br />&#160;&#160;&#160; wreply.Append(request.Headers[&quot;Host&quot;] ?? requestUrl.Authority);       <br />&#160;&#160;&#160; wreply.Append(request.ApplicationPath); </font></p>  <p><font face="Courier New">&#160;&#160;&#160; if (!request.ApplicationPath.EndsWith(&quot;/&quot;))      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; wreply.Append(&quot;/&quot;);       <br />&#160;&#160;&#160; e.SignInRequestMessage.Reply = wreply.ToString();       <br />&#160;&#160;&#160; e.SignInRequestMessage.Realm = wreply.ToString();       <br />} </font></p>  <p>We also need to add an audience URI in the <em>web.config</em> for 127.0.0.1 (if like me you did register to the STS as localhost).</p>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160; &lt;audienceUris&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;add value=&quot;</font><font face="Courier New">https://127.0.0.1:444/&quot;</font><font face="Courier New"> /&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;add value=&quot;</font><font face="Courier New">https://localhost:444/&quot;</font><font face="Courier New"> /&gt;      <br /></font></p> <font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;add value=&quot;</font><font face="Courier New">https://***.cloudapp.net/&quot;</font><font face="Courier New"> /&gt;    <br /></font><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/audienceUris&gt;</font>   <p>I am now prepared to deploy my application in Windows Azure.</p>  <h4>Copy Local</h4>  <p>Now here is an issue that took me <strong>a lot of time</strong> to resolve.&#160; Every time you put dlls that aren’t part of the .NET Framework or your projects, you have to specify <em>Copy Local</em> to <em>true</em> in the assembly property.</p>  <p><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="image" border="0" alt="image" src="assets/2010/8/departmental-application-migration-to-azure-part-4-adfs-with-azure-web-app/image14.png" width="244" height="346" /> </p>  <p></p>  <p>This is our case for the WIF assemblies.&#160; This setting will force the WIF assembly to be packaged and sent to the cloud with the rest of the custom code.</p>  <h3>Deploying ADFS integration to the cloud</h3>  <p>I deploy the application to the staging Windows Azure environment.&#160; As mentioned before, this environment won’t fully work since the URL is not constant.</p>  <p>Once it’s in staging I flick it to production.</p>  <p>Et voila!</p>  <p>So, not too trivial to setup, but in the range of the feasible ;)</p>