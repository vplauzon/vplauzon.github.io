---
title:  Event bus in Windows Azure
date:  2010-08-04 17:09:52 +00:00
permalink:  "/2010/08/04/event-bus-in-windows-azure/"
categories:
- Solution
tags:  []
---
<p>Ok, that’s it, I’m started for feature requests on Windows Azure with my last <a href="http://vincentlauzon.wordpress.com/2010/08/04/querying-azure-storage/">Blog Entry</a>, let’s keep going!</p>  <p><img style="display:inline;margin-left:0;margin-right:0;" align="right" src="http://www.azurejournal.com/wp-content/uploads/2008/10/azuredatastorage.png" />I’ve spoke about how Azure Storage, and more specifically Azure Tables, lack querying capabilities.&#160; Another Azure Storage component, Azure Queues, also lack a big feature:&#160; notification!</p>  <p>To some extent Azure queues are even less optional than Azure tables.&#160; They are the best communication mechanism between different roles.&#160; The architecture is quite elegant and simple.&#160; Removing ACID transactions from the picture of course helped lot in simplifying the architecture (look at how SQL Server Broker Services handles poison messages for instance).</p>  <p>Queues have always been a great communication mechanism within distributed architecture and not considered enough within the Microsoft community to my opinion.</p>  <p>Now, as I said, a big feature that Azure Queues are lacking is notification.&#160; The only model we have to access a queue is probing:&#160; ask the queue if it has any messages.&#160; Now that’s ok if you have an ad hoc application starting and wondering if it got mail.&#160; But for a background process (ie Worker Role) processing messages from a queue, that means probing the queue continuously.&#160; This approach has many shortfalls:</p>  <ol>   <li>Each time you probe an Azure Queue, you’re charged for it.&#160; It’s very cheap, but if you probe the queue multiple times a seconds, charges adds up.</li>    <li>You can actually overflow the queue with queries, in which case it will return error messages to back you off.</li>    <li>If you want to avoid that, you can implement some logic in your code where you probe often, then when there’s nothing, you back off exponentially.&#160; The issue with this approach is that when a message finally comes in, you’ll pick it up late.</li>    <li>Your worker role is spinning and consuming CPU just to make sure the queue is empty.</li> </ol>  <p>Of course, a good solution to those problems is notification:&#160; have your worker role enlist to a notification engine that will call it when a message comes in.&#160; There are no notification engine currently.</p>  <p>Now if you step back a little and think about it, you can generalize this solution and it would solve many problems.&#160; The general solution would be to have an Azure event bus and have different components optionally publishing or listening to it.&#160; For instance, you might want to take some action when an Azure Table or an Azure Blob is modified (sort of a clean trigger), when an SQL Azure schema is modified, when a role is taken offline or another is brought online, etc.&#160; .</p>  <p>Of course, as usual, this isn’t trivial in the could.&#160; You would need this event bus to be distributed in order to be reliable, but mostly, you would need to fix the usual problems of notifications.&#160; For instance, what does the notification engine do if it can’t reach my role?&#160; Does it retry, does it un-enlist my role from the notification?&#160; Should we support notification clients outside Windows Azure walls?</p>  <p>Well, actually, a simpler solution would actually to come back to queues.&#160; Why not enlist to notifications via a queue you’re monitoring?&#160; For instance, you could specify you would like to be notified when something happened to an Azure Table and those notifications would be posted in your queue.</p>  <p>Ah yeah, but we would still need a notification engine for the queue itself then!&#160; Well, I think it would be acceptable if would only be supported for roles hosted within Windows Azure and it could be baked in directly into the runtime, so that no TCP or HTTP endpoint would need to be explicitly exposed:&#160; the platform would take car of it and raise a .NET event.&#160; That solution wouldn’t be non-.NET friendly though, true.</p>  <p>But I know first hand that it would be handy since I have to bake in a notification scheme into an Azure Application I’m architecting right now.&#160; This is the type of infrastructure that takes time to build and stabilize and add no direct value to an application.&#160; It would be of immense value for Windows Azure to support this feature built-in!</p>