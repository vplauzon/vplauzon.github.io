---
title: Departmental Application Migration to Azure - Part 2 – ADFS Installation
date: 2010-06-02 16:05:22 -04:00
permalink: /2010/06/02/departmental-application-migration-to-azure-part-2-adfs-installation/
categories:
- Solution
tags: []
---
<p>This is part of a series of blogs.&#160; See the preceding blog entries:</p>  <ul>   <li><a href="http://vincentlauzon.wordpress.com/2010/06/02/departmental-application-migration-to-azure-part-1/">Departmental Application Migration to Azure – Part 1</a> </li> </ul>  <p>Let’s start with ADFS.</p>  <p>First of all, why using ADFS on this project?&#160; In short but mystical terms:&#160; to extend the corporate identity to the cloud.&#160; In layman terms, to allow Windows Azure to authenticate a corporate user without passing through the corporate firewall.&#160; To illustrate this, let’s look at the architecture without ADFS:</p>  <p><a href="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image.png"><img style="display:block;float:none;margin-left:auto;margin-right:auto;border-width:0;" title="image" border="0" alt="image" src="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image_thumb.png" width="527" height="594" /></a> Basically, the user, sitting behind the corporate firewall, contacts the application deployed in the cloud.&#160; But since there is no relationship between our Corporate Active Directory and Windows Azure, the application is unable to authenticate the user.</p>  <p>Enters Active Directory Federation Services 2.0.&#160; ADFS is a service in front of your Active Directory.&#160; It uses AD to authenticate you and packages a SAML token for the application (called a <em>relying party</em> in the context of claims based security) to use.&#160; The relationship between ADFS and the application is a trust relationship:&#160; there are no network connections between the application and ADFS.&#160; Basically, your application is configured to accept SAML tokens from your ADFS.</p>  <p><a href="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image1.png"><img style="display:block;float:none;margin-left:auto;margin-right:auto;border-width:0;" title="image" border="0" alt="image" src="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image_thumb1.png" width="527" height="685" /></a>The typical flow for authentication is the following:</p>  <ul>   <li>User connect to the web application </li>    <li>The web application checks for an authentication cookie, doesn’t find one.&#160; It forwards the user to an ADFS login page. </li>    <li>The user automatically authenticates (being on its corporate network). </li>    <li>ADFS posts the SAML token back to the application </li>    <li>The application creates a cookie </li>    <li>The user has access to the application </li> </ul>  <p>Actually, ADFS version 2.0 enables much more than that.&#160; It moves away from Active Directory role based access control (RBAC) to claims based.&#160; I encourage you to read the excellent <a href="http://www.microsoft.com/downloads/details.aspx?familyid=4C09FFE4-43DD-4FCC-BE35-C897C9BC4386&amp;displaylang=en">Guide to Claims-Based Identity and Access Control book available</a> on Microsoft downloads to learn more about the exciting world of Claims based security.</p>  <p>You can download ADFS version 2.0 <a href="http://technet.microsoft.com/en-us/evalcenter/ee476597.aspx">here</a>.&#160; Straightforward to install.&#160; You need to reboot after the install and then configure the service on your machine, using the ADFS add-on on your Administrative tools.</p>  <p>Here I’ll show you how I configured it on my virtual machine.&#160; I was doing a demo-type of installation, so I didn’t worry about scalability or robustness.&#160; My installation was equivalent to installing SharePoint entirely on one server using SQL Express.</p>  <p>On the first screen, I chose to create a new Federation Service (since there was none yet).</p>  <p><a href="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image2.png"><img style="display:block;float:none;margin-left:auto;margin-right:auto;border-width:0;" title="image" border="0" alt="image" src="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image_thumb2.png" width="724" height="579" /></a></p>  <p></p>  <p></p>  <p></p>  <p>On the second screen, I chose the stand-alone federation server installation.</p>  <p><a href="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image3.png"><img style="display:block;float:none;margin-left:auto;margin-right:auto;border-width:0;" title="image" border="0" alt="image" src="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image_thumb3.png" width="724" height="579" /></a> On the next screen, I have to pick a certificate I just created in order to continue.&#160; To learn how to create a self-signed certificate, <a href="http://technet.microsoft.com/en-us/library/cc753127(WS.10).aspx">read this</a>.</p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p><a href="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image4.png"><img style="display:block;float:none;margin-left:auto;margin-right:auto;border-width:0;" title="image" border="0" alt="image" src="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image_thumb4.png" width="724" height="579" /></a> On the next screen, nothing needs to be done.&#160; It’s the last step before the actual configuration is implemented.</p>  <p><a href="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image5.png"><img style="display:block;float:none;margin-left:auto;margin-right:auto;border-width:0;" title="image" border="0" alt="image" src="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image_thumb5.png" width="724" height="579" /></a></p>  <p>The next screen shows the progress of the configuration going on.</p>  <p><a href="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image6.png"><img style="display:block;float:none;margin-left:auto;margin-right:auto;border-width:0;" title="image" border="0" alt="image" src="/assets/2010/6/departmental-application-migration-to-azure-part-2-adfs-installation/image_thumb6.png" width="724" height="579" /></a></p>  <p>With this ADFS is installed on your machine.&#160; On the next blog entry, I’ll configure ADFS to work with my application (relying party).</p>