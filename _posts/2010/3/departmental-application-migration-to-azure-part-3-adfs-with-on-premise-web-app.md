---
title: Departmental Application Migration to Azure – Part 3 – ADFS with on-premise web app
date: 2010-07-15 13:52:20 -07:00
permalink: /2010/07/15/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/
categories:
- Solution
tags:
- Security
---
<p>This is part of a series of blogs.&#160; See the preceding blog entries:</p>  <ul>   <li><a href="http://vincentlauzon.wordpress.com/2010/06/02/departmental-application-migration-to-azure-part-1/">Departmental Application Migration to Azure – Part 1</a> </li>    <li><a href="http://vincentlauzon.wordpress.com/2010/06/02/departmental-application-migration-to-azure-part-2-adfs-installation/">Departmental Application Migration to Azure – Part 2 – ADFS Installation</a> </li> </ul>  <p>For me, authentication is the major challenge for this proof of concept.&#160; The migration of our tiny database, the web application that will manage it, etc., that’s pretty trivial.&#160; The issue is:&#160; how are we going to authenticate against this cloud application?&#160; The answer is:&#160; the same way we do inside the company, with Active Directory Single Sign on.</p>  <p>Using AD SSO in the cloud is way trickier than on premise though.&#160; The easiest way I found was to use ADFS 2.0.&#160; In this article, I’ll develop a trivial web app using ADFS to authenticate.&#160; The app will still be on premise, but it could be elsewhere.</p>  <p>I extensively used the <a href="http://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=c3e315fa-94e2-4028-99cb-904369f177c0">WIF Developer Training Kit</a> in order to achieve what I’m going to show in this blog post.&#160; The part the training kit doesn’t cover is ADFS.</p>  <h3>Prerequisite</h3>  <p>You need to have ADFS 2.0 installed.&#160; This was covered in the <a href="http://vincentlauzon.wordpress.com/2010/06/02/departmental-application-migration-to-azure-part-2-adfs-installation/">previous blog entry</a> from this series.</p>  <p>Then you’ll need the Windows Identity Foundation (WIF) SDK.&#160; You can download it at <a title="http://www.microsoft.com/downloads/details.aspx?familyid=C148B2DF-C7AF-46BB-9162-2C9422208504&amp;displaylang=en" href="http://www.microsoft.com/downloads/details.aspx?familyid=C148B2DF-C7AF-46BB-9162-2C9422208504&amp;displaylang=en">http://www.microsoft.com/downloads/details.aspx?familyid=C148B2DF-C7AF-46BB-9162-2C9422208504&amp;displaylang=en</a>.</p>  <p>I’ll use Visual Studio 2010.&#160; I suppose you could use Visual Studio 2008, but I didn’t try it.</p>  <h3>Basic web site</h3>  <p>The first thing I’ll do is create a trivial web site.&#160; So in Visual Studio, I create an ASP.NET Web Application called <em>AdfsAuthenticatedWebSite</em>:</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image3.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb3.png" width="404" height="281" /></a></p>  <p>This creates a boiler plate ASP.NET application.&#160; First thing I’ll do is to clean-up this application:</p>  <ul>   <li>Delete the <em>Account</em> folder since ADFS will perform those functions. </li>    <li>In web.config:      <ul>       <li>Delete the <em>connection</em> string. </li>        <li>Delete the <em>authentication</em> xml node. </li>        <li>Delete the <em>membership</em> xml node. </li>        <li>Delete the <em>profile</em> xml node. </li>        <li>Delete the <em>roleManager</em> xml node. </li>     </ul>   </li> </ul>  <p>Then, I’ll set IIS to run the web site on <a title="https://localhost/AdfsAuthenticatedWebSite" href="https://localhost/AdfsAuthenticatedWebSite">https://localhost/AdfsAuthenticatedWebSite</a> (on SSL) and create the virtual directory.&#160; This is important because the web site needs to be secured in order to accept posted tokens.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image4.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb4.png" width="404" height="244" /></a> </p>  <p>You can check that the application is still compiling and executing.&#160; The application is now using Windows Integrated Authentication (ASP.NET default’s).</p>  <h3>Connecting the application to the STS</h3>  <p>We are ready to start integrating the application with our STS.&#160; STS stands for <em>Security Token Service</em>.&#160; It’s a component able to authenticate a user and package the user’s claims into a standard token (typically SAML).&#160; ADFS is a STS, so we’re going to connect to it.</p>  <p>Now, connecting to an STS is a two ways process.&#160; The STS needs to know about your application (it doesn’t package the same types of claims for every application) and your application needs to know about the STS (minimally to know the encryption key to use to open the token).</p>  <p>We’ll start by having the application know about ADFS.&#160; Right click the project and select <em>Add STS reference.</em></p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image5.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb5.png" width="237" height="484" /></a> </p>  <p>The Wizard needs to access the application <em>web.config</em> file, because it’s going to modify it.&#160; It also need to know about your application URI, which sorts of identify your app.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image6.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb6.png" width="404" height="304" /></a> </p>  <p></p>  <p>On the next screen, we’ll select the <em>Use an existing STS</em> option and give the URL to ADFS Federation metadata.&#160; If you followed my ADFS installation procedure, the metadata is located at <a title="https://localhost/FederationMetadata/2007-06/federationmetadata.xml" href="https://localhost/FederationMetadata/2007-06/federationmetadata.xml">https://localhost/FederationMetadata/2007-06/federationmetadata.xml</a>.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image29.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image29_thumb.png" width="404" height="304" /></a> </p>  <p>The next screen is about the encryption of the token.&#160; I chose the certificate I’ve created for ADFS to encrypt the token.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image34.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image34_thumb.png" width="404" height="304" /></a> </p>  <p>The next screen shows you the claims available.&#160; The last screen gives you the option to schedule a sync between the application and the STS.&#160; I didn’t use this.</p>  <p>The wizard did two things:</p>  <ol>   <li>Generated the application’s metadata and put it in the folder <em>FederationMetadata/2007-06</em> </li>    <li>Alter considerably the <em>web.config</em> file. </li> </ol>  <p>I try to test the web site afterwards, browsing to <a title="https://localhost/AdfsAuthenticatedWebSite" href="https://localhost/AdfsAuthenticatedWebSite">https://localhost/AdfsAuthenticatedWebSite</a>.&#160; If you have an error on the ADFS web site, that’s normal, it isn’t configured yet.</p>  <p>On my side, I got a security error on the application site due to my certificates being inaccessible by IIS user, something along the lines of <em>ID1039: The certificate's private key could not be accessed. Ensure the access control list (ACL) on the certificate's private key grants access to the application pool user</em>.&#160; I found a solution to that problem <a href="http://cloudy.liangz.info/2009/10/running-samples-of-geneva-beta-2-in.html">on the web</a>.&#160; Basically, you have to give READ permission to the group IIS_IUSRS to the files located at <em>%ALLUSERSPROFILE%\Microsoft\Crypto\RSA\MachineKeys</em>.</p>  <h3>Connecting the STS to the application</h3>  <p>Now we are going to connect ADFS to our application.</p>  <p>We start by opening the ADFS Management Snap-In.&#160; On the right-hand pane, we select <em>Add Relying Party</em>.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image7.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb7.png" width="404" height="291" /></a> </p>  <p>We start the wizard.&#160; On the first screen, we need to import the application meta data.&#160; We can point directly to its URL:&#160; <a title="http://localhost:44930/FederationMetadata/2007-06/FederationMetadata.xml" href="https://localhost//FederationMetadata/2007-06/FederationMetadata.xml">https://localhost/AdfsAuthenticatedWebSite/FederationMetadata/2007-06/FederationMetadata.xml</a>.&#160; This URL is the only one accessible anonymously on the web application since the rest of the web site is secured with ADFS which isn’t properly configured.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image8.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb8.png" width="404" height="324" /></a> </p>  <p></p>  <p>On the next screen, we enter the display name and some notes.&#160; This data is only useful for display purpose within AD FS console.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image9.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb9.png" width="404" height="324" /></a> </p>  <p>On the next screen, we could opt-in to ADFS doing some authorization by denying access to some users.&#160; I won’t do that here since I want to do it in my application and I want ADFS to only work as an STS.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image10.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb10.png" width="404" height="324" /></a> </p>  <p>On the next two screens, we basically just accept and move on.&#160; The last screen will open the <em>Edit Claim Rules</em> dialog.</p>  <h3>Entering Claim Rules</h3>  <p>Here, we’ll concentrate on configuring ADFS to send certain claims to our application.&#160; The way to do this in ADFS is by entering claim transformation rules.&#160; Basically, Active Directory authenticate you and contains a bunch of claims (e.g. your name, email, your groups, etc.) and ADFS transforms those claims and put the result in a token.</p>  <p>I won’t do any fancy transformation:&#160; I’ll recover the name, e-mail and a few groups of the user.&#160; I’ll do that in two different claim transformation rules.</p>  <p>First, let’s add a rule.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image11.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb11.png" width="404" height="438" /></a> </p>  <p></p>  <p>We’ll use the default claim rule template, which is to send LDAP attributes as claims.&#160; LDAP is the protocol used by Active Directory.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image12.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb12.png" width="404" height="323" /></a> </p>  <p>I enter <em>Fetch attributes</em> as the claim rule name and choose <em>Active Directory</em> as the attribute store.&#160; I’ll fetch 3 attributes by simply mapping the LDAP (AD) attributes to claim types, which are predefined standard types.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image13.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb13.png" width="404" height="425" /></a> </p>  <p>The next claim rule is slightly more fancy.&#160; I’m using the <em>Send Group Membership as Claims</em> template.&#160; I basically map an AD group (my company’s Architect group) to a claim role.&#160; If the user is part of that AD group, there will be a claim with the specified outgoing claim value, otherwise, that claim won’t be there.</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image14.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb14.png" width="404" height="324" /></a> </p>  <p>…&#160; and I’m done configuring ADFS for now.</p>  <h3>Last Glitch</h3>  <p>Now I’m reading to use my web site at <a title="https://localhost/AdfsAuthenticatedWebSite/" href="https://localhost/AdfsAuthenticatedWebSite">https://localhost/AdfsAuthenticatedWebSite</a>.</p>  <p>Bang!&#160; Definitely, nothing’s easy with this demo!</p>  <p><a href="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image15.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="image" border="0" alt="image" src="/assets/posts/2010/3/departmental-application-migration-to-azure-part-3-adfs-with-on-premise-web-app/image_thumb15.png" width="404" height="244" /></a> </p>  <p>Ok, this is a <a href="http://msdn.microsoft.com/en-us/library/ee517280.aspx">known issue</a> with WIF.&#160; Basically, ADFS sends back the security token in the post back and my web site fails to validate that token and detects it as a cross site attack (which it is in some sense).</p>  <p>The known work around is to disable page validation across the board or to write a custom <em>RequestValidator</em> that will skip that validation for the specific WIF post back.&#160; Here I’ll use the <em>RequestValidator</em>.&#160; I create a file <em>WifRequestValidator.cs</em> with the following code in it:</p>  <p><font color="#8000ff" face="Courier New">using System;     <br />using System.Web;      <br />using System.Web.Util;      <br />using Microsoft.IdentityModel.Protocols.WSFederation; </font></p>  <p><font color="#8000ff" face="Courier New">namespace AdfsAuthenticatedWebSite     <br />{      <br />&#160;&#160;&#160; public class WifRequestValidator : RequestValidator      <br />&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; protected override bool IsValidRequestString(HttpContext context, string value, RequestValidationSource requestValidationSource, string collectionKey, out int validationFailureIndex)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; validationFailureIndex = 0; </font></p>  <p><font color="#8000ff" face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (requestValidationSource == RequestValidationSource.Form &amp;&amp; collectionKey.Equals(WSFederationConstants.Parameters.Result, StringComparison.Ordinal))     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; SignInResponseMessage message = WSFederationMessage.CreateFromFormPost(context.Request) as SignInResponseMessage; </font></p>  <p><font color="#8000ff" face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (message != null)     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return true;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </font></p>  <p><font color="#8000ff" face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return base.IsValidRequestString(context, value, requestValidationSource, collectionKey, out validationFailureIndex);     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }      <br />&#160;&#160;&#160; }      <br />}</font></p>  <p>I then add this component in the <em>web.config</em>: </p>  <p><font color="#8000ff" face="Courier New">&lt;system.web&gt;</font>    <br /><font color="#8000ff" face="Courier New">&#160; &lt;httpRuntime requestValidationType = &quot;AdfsAuthenticatedWebSite.WifRequestValidator&quot; /&gt;</font></p>  <p>Doing that, I can finally login automatically to my site.</p>  <h3>Using the claims</h3>  <p>Now I have my identity set by the WIF module.&#160; Let’s use the claims I configured in ADFS!</p>  <p>For that, I’ll modify the <em>Default.aspx</em>, more specifically I’ll zap the content of <em>MainContent</em> content place holder and replace it by:</p>  <p><font color="#800080" face="Courier New">&lt;asp:Content ID=&quot;BodyContent&quot; runat=&quot;server&quot; ContentPlaceHolderID=&quot;MainContent&quot;&gt;     <br />&#160;&#160;&#160; &lt;p&gt;Your claims:&lt;/p&gt;      <br />&#160;&#160;&#160; &lt;asp:GridView ID=&quot;gridView&quot; runat=&quot;server&quot; AutoGenerateColumns=&quot;False&quot;&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;Columns&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;asp:BoundField DataField=&quot;ClaimType&quot; HeaderText=&quot;ClaimType&quot; ReadOnly=&quot;True&quot; /&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;asp:BoundField DataField=&quot;Value&quot; HeaderText=&quot;Value&quot; ReadOnly=&quot;True&quot; /&gt;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/Columns&gt;      <br />&#160;&#160;&#160; &lt;/asp:GridView&gt;      <br />&lt;/asp:Content&gt;</font></p>  <p>In the code behind, in the Page_Load method, we put:</p>  <p><font color="#800080" face="Courier New">protected void Page_Load(object sender, EventArgs e)     <br />{      <br />&#160;&#160;&#160; IClaimsIdentity claimsIdentity = ((IClaimsPrincipal)(Thread.CurrentPrincipal)).Identities.FirstOrDefault(); </font></p>  <p><font color="#800080" face="Courier New">&#160;&#160;&#160; if (claimsIdentity != null)     <br />&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; gridView.DataSource = claimsIdentity.Claims;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; gridView.DataBind();      <br />&#160;&#160;&#160; }      <br />} </font></p>  <p>The code basically binds all the claims to a grid view.&#160; When I execute the page, I see the AD-extracted attributes and two others:&#160; the authentication method and the time when the authentication took place.</p>  <p>This basically concludes the proof-of-concept I was doing.</p>  <h3>Conclusion</h3>  <p>In order to create a web site where the authentication is managed by ADFS and exposed as claims, I needed to:</p>  <ul>   <li>Create a web site</li>    <li>Add a STS (ADFS) reference to it</li>    <li>Add the web site (application) as a relying party in ADFS</li>    <li>Configure some claims transformation in ADFS</li>    <li>Consume the claims in the application</li> </ul>  <p>I did face a few glitches, mostly:</p>  <ul>   <li>The certificate wasn’t accessible by the app pool user</li>    <li>The token isn’t recognized as valid by my web page</li> </ul>  <p>Once this is setup though, the thing runs like a charm.&#160; ADFS is pretty easy and hassle-free to use and consuming claims in the application is also easy.</p>  <p>Now, being claim based gives me two advantages.</p>  <p>The first one is the advantage of claims in general:&#160; it decouples my application to the authentication mechanism (Active Directory in this case).&#160; Tomorrow I can switch Active Directory for Live ID and my application won’t need modifications.&#160; Ok, not too likely.&#160; A more realistic gain is that it gives one-and-only-one framework for developers to consume a user identity.</p>  <p>The second advantage is that I’m now Azure ready!&#160; Azure apps won’t go interrogating my Active Directory (which is behind a firewall anyway), but they can go interrogating ADFS.&#160; ADFS can even be behind the firewall, as long as the user is also sitting behind the firewall since the authentication is happening on his desktop.</p>  <p>In a future blog, I’ll actually build an application for Azure doing the exact same thing.</p>