---
title: Delaying action at transaction commit
date: 2012-09-28 19:03:00 -04:00
permalink: /2012/09/28/delaying-action-at-transaction-commit/
categories:
- Solution
tags:
- Data
---
<p>I am designing a back-end where Database contention is the number-one issue for scalability.</p>  <p>We use those darn distributed transactions and therefore I do not know how long the transaction my component is participating into will last.&#160; If a transaction remains open for a few seconds, many of those would create contention in the Database my component is using.&#160; This will result in dead-locks, time-outs and scalability would go out of the window.</p>  <p>I didn’t want to go the all no-sql way and forgo any transaction management.&#160; The crux of the deal is that during one of those distributed transaction, we are inserting one record while a recurrent task performs a large and complicated select on the entire table.&#160; I though if I could wait long enough to insert, until the end of the transaction, I would reduce the contention.&#160; Here is how to do it.</p>  <p>First, what you do not want to do is to hook on the <a href="http://msdn.microsoft.com/en-us/library/system.transactions.transaction.transactioncompleted.aspx">TransactionCompleted</a> event of the <a href="http://msdn.microsoft.com/en-us/library/system.transactions.transaction.current.aspx">Transaction.Current</a> object.&#160; It is tempting, it is easy, it is right at hand, but it doesn’t work.&#160; Well…&#160; it works but whatever code you run in the event handler will exist outside the transaction since as the name of the event suggests, the transaction has already completed by then.&#160; The point of using transaction is to have many actions being atomically bundled so I didn’t want to have a key operation happening outside the transaction.</p>  <p>The real solution isn’t that much more complicated actually.&#160; Check out <a href="http://msdn.microsoft.com/en-us/library/ms149779.aspx">Transaction.Current.EnlistVolatile</a>.&#160; This method allow you to hook yourself in the transaction process.&#160; You basically become a transaction participant.&#160; We use the volatile version of the method since we do not want to appear as a durable participant since that would involve us being able, like the antic <a href="http://en.wikipedia.org/wiki/Phoenix_(mythology)">Pheonix</a>, to be born again from our ashes if the process fail.&#160; No need for that, I was happy for this to work only if the original process stayed online for the duration of the transaction.</p>  <blockquote>   <p>public Enlistment EnlistVolatile( IEnlistmentNotification enlistmentNotification, EnlistmentOptions enlistmentOptions ) </p> </blockquote>  <p>We need to implement the <a href="http://msdn.microsoft.com/en-us/library/system.transactions.ienlistmentnotification.aspx">IEnlistmentNotification</a> interface:</p>  <blockquote>   <p>public interface IEnlistmentNotification     <br />&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; void Commit(Enlistment enlistment);      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; void InDoubt(Enlistment enlistment);      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; void Prepare(PreparingEnlistment preparingEnlistment);      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; void Rollback(Enlistment enlistment);      <br />&#160;&#160;&#160; }</p> </blockquote>  <p>In my case I simply needed to hold a few variable within the object implementing that interface.&#160; Basically the data I wanted to insert in the DB and the <em><a href="http://msdn.microsoft.com/en-us/library/e5c62w6d.aspx">Transaction</a></em> instance itself. Then I had the simple following implementation:</p>  <ul>   <li>In <a href="http://msdn.microsoft.com/en-us/library/system.transactions.ienlistmentnotification.prepare.aspx">Prepare</a>, do the insertion and call <a href="http://msdn.microsoft.com/en-us/library/system.transactions.enlistment.done.aspx">PreparingEnlistment.Prepared</a>.&#160; This last step is essential since we simulate a transaction resource, we need to confirmed that we prepared in the two-phase commit.</li>    <li>In <a href="http://msdn.microsoft.com/en-us/library/system.transactions.ienlistmentnotification.commit.aspx">Commit</a>, simply call <a href="http://msdn.microsoft.com/en-us/library/system.transactions.enlistment.done.aspx">Enlistment.Done</a>.</li> </ul>  <p>That’s it!&#160; You’re now in the Transaction pipeline and can do late operations.</p>