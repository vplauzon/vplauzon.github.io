---
title: 'SQL Azure Federation: Automating your database partitioning (sharding)'
date: 2011-02-05 10:20:00 -05:00
permalink: /2011/02/05/sql-azure-federation-automating-your-database-partitioning-sharding/
categories:
- Solution
tags:
- Data
---
<p>Microsoft is about to introduce the federation concept into SQL Azure.&#160; You can read about it on Microsoft SQL Azure Program Manager <a href="http://blogs.msdn.com/b/cbiyikoglu/">Cihan Biyikoglu’s blog</a>:</p>  <ul>   <li><a href="http://blogs.msdn.com/b/cbiyikoglu/archive/2010/10/30/building-scalable-database-solution-in-sql-azure-introducing-federation-in-sql-azure.aspx">Building Scalable Database Solution with SQL Azure - Introducing Federation in SQL Azure</a> </li>    <li><a href="http://blogs.msdn.com/b/cbiyikoglu/archive/2010/12/11/how-to-scale-out-an-app-with-sql-azure-federations-the-quintessential-sales-db-with-customer-and-orders.aspx">How to scale out an app with SQL Azure Federations… The Quintessential Sales DB with Customer and Orders</a> </li>    <li><a href="http://blogs.msdn.com/b/cbiyikoglu/archive/2011/01/18/sql-azure-federations-robust-connectivity-model-for-federated-data.aspx">SQL Azure Federations: Robust Connectivity Model for Federated Data</a> </li> </ul>  <p>The feature addresses scale-out scenarios for databases in the cloud.&#160; For context, when you want to increase the storage capacity of a system, you can either scale-up (buy a bigger database server connected on a bigger SAN) or you can scale-out (buy another cheap database server and put it next to the old one).</p>  <p>There are many pros &amp; cons for both approach.&#160; Basically with scale-up:</p>  <ul>   <li>You increase capacity without changing much on the applications:&#160; they still connect to one server. </li>    <li>The cost structure is geometric and passed a limit there’s just no hardware available. </li> </ul>  <p>With scale-out:</p>  <ul>   <li>Depending on how you do it, you can theoretically scale forever and cheaply. </li>    <li>Your applications need to change:&#160; they need to know which server to interrogate depending on what data they are manipulating. </li> </ul>  <p><img style="display:inline;margin-left:0;margin-right:0;" align="right" src="http://www.haute-disponibilite.net/wp-content/uploads/2008/09/hp-pod.png" width="300" height="207" />In the cloud in general as with Microsoft Cloud offering specifically, the philosophy is scale-out:&#160; massive amount of commodity hardware.</p>  <p>With Microsoft offering we had two scenarios for storage so far:</p>  <ul>   <li>Azure Storage (Table, Queue &amp; Blobs), 100 Tb of capacity limit. </li>    <li>SQL Azure, 50 GB of capacity limit. </li> </ul>  <p>The former is build for scale but is a new paradigm to use and in all fairness, it doesn’t have the maturity of the SQL Server, it offers basic storage operations.</p>  <p>SQL Azure is easy to use, it’s basically using SQL Server in the cloud if you forget a couple of caveat (such as <a href="http://vincentlauzon.wordpress.com/2010/11/29/sql-azure-acid-transactions-back-to-2001/">transaction management</a> &amp; connection stability).&#160; But SQL Azure is your good old relational database and hence is scale-up in nature:&#160; you start at 1GB with the cheapest web edition and end at 50GB with the most expensive business edition.</p>  <p>SQL Azure Federation blurs the cards a little.&#160; It offers a scale-out option to SQL Azure.</p>  <p>Now, don’t get too hyped up:&#160; it’s not like a federation switch you turn on and get infinite scale automatically.&#160; You still have to change your application.&#160; But it’s a huge improvement from managing partitioning yourself.</p>  <p>Let’s look at what it takes to scale-out a database doing horizontal partitioning (or sharding), which is what SQL Azure Federation manages for you.</p>  <p><a href="/assets/2011/2/sql-azure-federation-automating-your-database-partitioning-sharding/image.png"><img style="display:inline;margin-left:0;margin-right:0;border-width:0;" title="image" border="0" alt="image" align="left" src="/assets/2011/2/sql-azure-federation-automating-your-database-partitioning-sharding/image_thumb.png" width="516" height="319" /></a>Basically, we partition the data in different partition database, according to a partition key.&#160; A typical example is to take a customer table and partition it by region (regionID would be a partition key) so that all the customers of a given region are in the same database.</p>  <p>Now we need a partition directory in order to map a partition key to a partition database.&#160; Using the same customer example, if we only need 3 partition database, each database will contain more than one region, so we need a mechanism to map the partition key to the partition database.</p>  <p>Complexity emerges when you want to add, remove or rebalance partitions.&#160; You need to shove data from one partition-DB to another and keep the partition directory up-to-date in order to maintain the data integrity of your system.</p> <a href="/assets/2011/2/sql-azure-federation-automating-your-database-partitioning-sharding/image1.png"><img style="display:inline;margin-left:0;margin-right:0;border-width:0;" title="Partition!" border="0" alt="Partition!" align="right" src="/assets/2011/2/sql-azure-federation-automating-your-database-partitioning-sharding/image_thumb1.png" width="244" height="135" /></a>   <p>You can do that today and actually, this was Microsoft recommendation with SQL Azure until the introduction of SQL Azure Federation.&#160; What does that product / feature brings to the table?&#160; Basically, it manages the partition:&#160; you specify the partition key range for a given partition and SQL Azure Federation will create a partition DB, move data into it and keep the directory up-to-date.&#160; What it doesn’t do?&#160; It doesn’t determine the partition key, you have to specify them.&#160; It doesn’t determined to partitions (partition key ranges) by itself, you have to do that.&#160; Finally, when you want to do SQL commands, you first have to issue a «USE FEDERATION» command where you basically tell which federation key to use, which routes you (via a partition directory) to the right DB.</p>  <p>So not only you need to do maintenance on the partitions by monitoring the partition DB size but you also need to modify your application to issue this partition-routing command before each query.&#160; A side effect of those constraints is that you can’t do a query spanning more than one partition key, which can mean complexity in your application.</p>  <p>On the other hand, SQL Azure Federation takes care of all the data movement and partition directory for you.&#160; This is no small task.</p>  <p>So if you started to think about how you would manage your sharding strategy by yourself, SQL Azure Federation is a life saver.&#160; If you were wondering how you could have a more than 50GB SQL Azure DB, then SQL Azure Federation must sound pretty complicated to you!</p>