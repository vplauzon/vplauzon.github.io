---
title:  Entity Framework 4.1: Complex Types (4)
date:  2011-04-14 00:55:00 +00:00
permalink:  "/2011/04/13/entity-framework-4-1-complex-types-4/"
categories:
- Solution
tags:
- .NET
---
<p>This is part of a series of blog post about Entity Framework 4.1.&#160; The past blog entries are:</p>  <ul>   <li><a href="http://vincentlauzon.wordpress.com/2011/04/03/entity-framework-4-1-basics-1/">Basics (1)</a> </li>    <li><a href="http://vincentlauzon.wordpress.com/2011/04/06/entity-framework-4-1-override-conventions-2/">Override conventions (2)</a> </li>    <li><a href="http://vincentlauzon.wordpress.com/2011/04/11/entity-framework-4-1-deep-fetch-vs-lazy-load-3/">Deep Fetch vs Lazy Load (3)</a> </li> </ul>  <p>In this article, I’ll cover the complex types.</p>  <p>By default, EF 4.1 is mapping classes to table.&#160; That is convenient but sometimes, we would like our model to be a bit more granular than the tables.</p>  <p>A classical example is an <em>address</em> class.&#160; Let’s say we have the following <em>client</em> class:</p>  <blockquote>   <p>public class Client      <br />{       <br />&#160;&#160;&#160; public int ClientID { get; set; }       <br />&#160;&#160;&#160; [Required]       <br />&#160;&#160;&#160; [StringLength(32, MinimumLength=2)]       <br />&#160;&#160;&#160; public string ClientName { get; set; }       <br />&#160;&#160;&#160; public Address ResidentialAddress { get; set; }       <br />&#160;&#160;&#160; public Address DeliveryAddress { get; set; }       <br />} </p>    <p>public class Address      <br />{       <br />&#160;&#160;&#160; [Required]       <br />&#160;&#160;&#160; public int StreetNumber { get; set; }       <br />&#160;&#160;&#160; [Required]       <br />&#160;&#160;&#160; [StringLength(32, MinimumLength=2)]       <br />&#160;&#160;&#160; public string StreetName { get; set; }       <br />} </p> </blockquote>  <p>We do not want the two address properties to map to an entry in an address table.&#160; Instead we want EF 4.1 to map the entire class to one table, flattening the address properties.&#160; How do we go about that?&#160; Enters complex types.</p>  <p>As we’ve seen <a href="http://vincentlauzon.wordpress.com/2011/04/06/entity-framework-4-1-override-conventions-2/">previously</a>, there’s always an attribute and a model-builder path when we want to override conventions.&#160; As I mentioned, I recommend going with the attributes when we enrich the model with business elements (e.g. required field).&#160; I consider complex types as a detail of mapping classes to tables, hence I won’t use attributes.&#160; I’ll do it all the model builder way:</p>  <blockquote>   <p>protected override void OnModelCreating(DbModelBuilder modelBuilder)      <br />{       <br />&#160;&#160;&#160; base.OnModelCreating(modelBuilder); </p>    <p>&#160;&#160;&#160; modelBuilder.Entity&lt;Client&gt;().Property(x =&gt; x.ClientID)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; .HasDatabaseGeneratedOption(DatabaseGeneratedOption.Identity);       <br />&#160;&#160;&#160; modelBuilder.ComplexType&lt;Address&gt;();       <br />&#160;&#160;&#160; modelBuilder.Entity&lt;Client&gt;().Property(i =&gt; i.ResidentialAddress.StreetNumber).HasColumnName(&quot;ResStreetNumber&quot;);       <br />&#160;&#160;&#160; modelBuilder.Entity&lt;Client&gt;().Property(i =&gt; i.ResidentialAddress.StreetName).HasColumnName(&quot;ResStreetName&quot;);       <br />&#160;&#160;&#160; modelBuilder.Entity&lt;Client&gt;().Property(i =&gt; i.DeliveryAddress.StreetNumber).HasColumnName(&quot;DelStreetNumber&quot;);       <br />&#160;&#160;&#160; modelBuilder.Entity&lt;Client&gt;().Property(i =&gt; i.DeliveryAddress.StreetName).HasColumnName(&quot;DelStreetName&quot;); </p>    <p>} </p> </blockquote>  <p>First I specify that client-id is an identity column (auto-incremental).&#160; Then I specify that the <em>address</em> class is a complex type.&#160; You can also put <em>[ComplexType]</em> on top of the class if you want.&#160; Then I do map each sub property (handing out the path of the sub property in the lambda expression) to a column name.&#160; This generates the following table:</p>  <p><a href="assets/2011/4/entity-framework-4-1-complex-types-4/image.png"><img style="display:inline;border-width:0;" title="image" border="0" alt="image" src="assets/2011/4/entity-framework-4-1-complex-types-4/image_thumb.png" width="354" height="219" /></a> </p>  <p>Now I can use the models:</p>  <blockquote>   <p>&#160;&#160;&#160; using (var context1 = new MyDomainContext())      <br />&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; var client = new Client       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ClientName = &quot;Joe&quot;,       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ResidentialAddress = new Address       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; StreetNumber = 15,       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; StreetName = &quot;Oxford&quot;       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; },       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; DeliveryAddress = new Address       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; StreetNumber = 514,       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; StreetName = &quot;Nolif&quot;       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; };       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; context1.Clients.Add(client); </p>    <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; context1.SaveChanges();      <br />&#160;&#160;&#160; }       <br />&#160;&#160;&#160; using (var context2 = new MyDomainContext())       <br />&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; var clients = from w in context2.Clients       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; where w.ClientName == &quot;Joe&quot;       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; select w; </p>    <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; foreach (var client in clients)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Console.WriteLine(&quot;client residential StreetNumber:&#160; &quot; + client.ResidentialAddress.StreetNumber);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Console.WriteLine(&quot;client residential StreetName:&#160; &quot; + client.ResidentialAddress.StreetName);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Console.WriteLine(&quot;client delivery StreetNumber:&#160; &quot; + client.DeliveryAddress.StreetNumber);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Console.WriteLine(&quot;client delivery StreetName:&#160; &quot; + client.DeliveryAddress.StreetName);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }       <br />&#160;&#160;&#160; }       <br /></p> </blockquote>  <p>The big caveat with complex types is the null management.&#160; Even if all the properties in the complex type are nullable, you can’t just hand out a null complex type.&#160; For instance, in this case, even if street name &amp; street number wouldn’t be required, I couldn’t have a client with a <em>null</em> residential address:&#160; I would need to new an address with everything null in it.&#160; The same way, when you retrieve an entity, EF 4.1 will always new the complex type even if everything is null in it.</p>