---
title: Joining an ARM Linux VM to AAD Domain Services
date: 2017-01-18 12:40:53 -05:00
permalink: /2017/01/18/joining-an-arm-linux-vm-to-aad-domain-services/
categories:
- Solution
tags:
- Identity
- Networking
- Virtual Machines
---
<p>Active Directory is one of the most popular domain controller / LDAP server around.</p> <p>In Azure we have Azure Active Directory (AAD).&nbsp; Despite the name, AAD isn’t just a multi-tenant AD.&nbsp; It is built for the cloud.</p> <p>Sometimes though, it is useful to have a traditional domain controller...&nbsp; in the cloud.&nbsp; Typically this is with legacy workloads built to work with Active Directory.&nbsp; But also, a very common scenario is to join an Azure VM to a domain so that users authenticate on it with the same accounts they authenticate to use the Azure Portal.</p> <p>The underlying directory could even be synced with a corporate network, in which case users could log into the VMs using their corporate account.&nbsp; I won’t cover this here but you can read about it in a <a href="https://vincentlauzon.com/2016/09/14/azure-active-directory-labs-series-ad-connect/">previous article for AD Connect part</a>.</p> <p>The straightforward option is to build an Active Directory cluster on Azure VMs.&nbsp; This will work but requires the maintenance of those 2 VMs.</p> <p><a href="/assets/2017/1/joining-an-arm-linux-vm-to-aad-domain-services/mont-saint-michel-france-normandy-europe11.jpg"><img title="mont-saint-michel-france-normandy-europe[1]" style="background-image:none;float:none;padding-top:0;padding-left:0;margin-left:auto;display:block;padding-right:0;margin-right:auto;border-width:0;" border="0" alt="mont-saint-michel-france-normandy-europe[1]" src="/assets/2017/1/joining-an-arm-linux-vm-to-aad-domain-services/mont-saint-michel-france-normandy-europe1_thumb1.jpg" width="640" height="425"/></a></p> <p>An easier option is <a href="https://docs.microsoft.com/en-us/azure/active-directory-domain-services/active-directory-ds-overview" target="_blank">AAD Domain Services (AADDS)</a>.&nbsp; AADDS exposes an AAD tenant as a managed domain service.&nbsp; It does it by provisioning some variant of Active Directory managed cluster, i.e. we do not see or care about the underlying VMs.</p> <p>The cluster is synchronized one-way (from AAD to AADDS).&nbsp; For this reason, AAD is read only through its LDAP interface, e.g. we can’t reset a password using LDAP.</p> <p>The <a href="https://docs.microsoft.com/en-us/azure/active-directory-domain-services/active-directory-ds-admin-guide-join-rhel-linux-vm" target="_blank">Azure documentation walks us through such an integration</a> with classic (ASM) VMs.&nbsp; Since ARM has been around for more than a year, I recommend to always go with ARM VMs.&nbsp; This article aims at showing how to do this.</p> <p>I’ll heavily leveraged the existing documentation and detail only what differs from the official documentation.</p> <p>Also, keep in mind this article is written in January 2017.&nbsp; Azure AD will transition to ARM in the future and will likely render this article obsolete.</p> <h2>Dual Networks</h2> <p>The main challenge we face is that AAD is an ASM service and AAD Domain Service are exposed within an ASM Virtual Network (VNET), which is incompatible with our ARM VM.</p> <p>Thankfully, we now have <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview" target="_blank">Virtual Network peering</a> allowing us to peer an ASM and an ARM VNET together so they can act as if they were one.</p> <p><a href="/assets/2017/1/joining-an-arm-linux-vm-to-aad-domain-services/image12.png"><img title="image" style="background-image:none;float:none;padding-top:0;padding-left:0;margin-left:auto;display:block;padding-right:0;margin-right:auto;border-width:0;" border="0" alt="image" src="/assets/2017/1/joining-an-arm-linux-vm-to-aad-domain-services/image_thumb12.png" width="502" height="374"/></a></p> <h2>Peering</h2> <p>As with all VNET peering, the two VNETs must be of mutually exclusive IP addresses space.</p> <p>I created two VNETs in the portal (<a href="https://portal.azure.com">https://portal.azure.com</a>).&nbsp; I recommend creating them in the new portal explicitly, this way even the classic one will be part of the desired resource group.</p> <p>The classic one has 10.0.0.0/24 address range while the ARM one has 10.1.0.0/24.</p> <p>The peering can be done from the portal too.&nbsp; In the Virtual Network pane (say the ARM one), select <em>Peerings</em>:</p> <p><a href="/assets/2017/1/joining-an-arm-linux-vm-to-aad-domain-services/image13.png"><img title="image" style="background-image:none;padding-top:0;padding-left:0;display:inline;padding-right:0;border-width:0;" border="0" alt="image" src="/assets/2017/1/joining-an-arm-linux-vm-to-aad-domain-services/image_thumb13.png" width="456" height="946"/></a></p> <p>We should see an empty list here, so let’s click <em>Add</em>.</p> <p>We need to give the peering a name.&nbsp; Let’s type <em>PeeringToDomainServices</em>.</p> <p>We then select <em>Classic</em> in the <em>Peer details</em> since we want to peer with a classic VNET.</p> <p>Finally, we’ll click on <em>Choose a Virtual Network</em>.</p> <p><a href="/assets/2017/1/joining-an-arm-linux-vm-to-aad-domain-services/image14.png"><img title="image" style="background-image:none;padding-top:0;padding-left:0;display:inline;padding-right:0;border-width:0;" border="0" alt="image" src="/assets/2017/1/joining-an-arm-linux-vm-to-aad-domain-services/image_thumb14.png" width="1014" height="774"/></a></p> <p>From there we should see the classic VNET we created.</p> <h2>Configuring AADDS</h2> <p>The online documentation is <a href="https://docs.microsoft.com/en-us/azure/active-directory-domain-services/active-directory-ds-getting-started-enableaadds" target="_blank">quite good for this</a>.</p> <p>Just make sure you select the classic VNET we created.</p> <p>You can give a domain name that is different that the AAD domain name (i.e. *.onmicrosoft.com).</p> <p>Enabling AADDS takes up to 30 minutes.&nbsp; Don’t hold your breath!</p> <h2>Joining a VM</h2> <p>We can create a Linux VM, put it in the ARM VNET we created, and join it to the AADDS domain now.</p> <p>Again, the <a href="https://docs.microsoft.com/en-us/azure/active-directory-domain-services/active-directory-ds-admin-guide-join-rhel-linux-vm" target="_blank">online documentation does a great job of walking us through the process</a>.&nbsp; The documentation is written for Red Hat.</p> <p>When I tried it, I used a CentOS VM and I ended up using different commands, namely the <a href="http://www.hexblot.com/blog/centos-7-active-directory-and-samba" target="_blank"><em>realmd command</em></a> (ignoring the SAMBA part of the article).</p> <h2>Conclusion</h2> <p>It is fairly straightforward to enable Domain Services in AAD and well documented.</p> <p>A challenge we currently have currently is to join or simply communicate from an ARM VM to AADDS.&nbsp; For this we need two networks, a classic (ASM) one and an ARM one, and we need to peer them together.</p>