---
title:  VNET Service Endpoints for Azure SQL & Storage
date:  10/02/2017 11:00:07
permalink:  "/2017/10/02/vnet-service-endpoints-for-azure-sql-storage/"
categories:
- Solution
tags:
- Networking
- Security
- Virtual Machines
---
<a href="assets/2017/10/vnet-service-endpoints-for-azure-sql-storage/internet-1676139_6401.jpg"><img width="300" height="228" title="internet-1676139_640" align="left" style="border:0 currentcolor;border-image:none;float:left;display:inline;background-image:none;" alt="internet-1676139_640" src="assets/2017/10/vnet-service-endpoints-for-azure-sql-storage/internet-1676139_640_thumb1.jpg" border="0" /></a>It’s finally here, it has arrived:&nbsp; Azure Virtual Network Service Endpoints.<p>This was a long requested “Enterprise feature”.</p><p>Let’s look at what this is and how to use it.</p><p>Please note that at the time of this writing (end-of-September 2017) this feature is available only in a <strong>few region in Public Preview</strong>:</p><ul><li><strong>Azure Storage</strong>: WestCentralUS, WestUS2, EastUS, WestUS, AustraliaEast, and AustraliaSouthEast 
</li><li><strong>Azure SQL Database</strong>: WestCentralUS, WestUS2, and EastUS</li></ul><h2>Online Resources</h2><p>Here is a bit of online documentation about the topic:</p><ul><li><a href="https://azure.microsoft.com/en-us/blog/azure-sql-database-vnet-service-endpoints-now-in-public-preview/" target="_blank">Service Launch blog</a></li><li><a href="https://docs.microsoft.com/en-ca/azure/virtual-network/virtual-network-service-endpoints-overview" target="_blank">Virtual Network Service Endpoints</a></li><li><a href="https://docs.microsoft.com/en-ca/azure/virtual-network/virtual-network-service-endpoints-configure" target="_blank">How to Configure Virtual Network Service Endpoints</a></li><li><a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-vnet-service-endpoint-rule-overview" target="_blank">Virtual Network Service Endpoints with Azure SQL</a></li><li><a href="https://docs.microsoft.com/en-ca/azure/storage/common/storage-network-security" target="_blank">Virtual Network Service Endpoints with Azure Storage</a></li><li><a href="https://docs.microsoft.com/en-ca/azure/virtual-network/security-overview#service-tags" target="_blank">Service Tags</a></li></ul><h2>The problem</h2><p>The first (historically) Azure Services, e.g. Azure Storage &amp; Azure SQL, were built with a public cloud philosophy:</p><ul><li>They are accessible through public IPs</li><li>They are multi-tenant, e.g. public IPs are shared between many domain names</li><li>They live on shared infrastructures (e.g. VMs)</li><li>etc.</li></ul><p>Many more recent services share many of those characteristics, for instance Data Factory, Event Hub, Cosmos DB, etc.&nbsp; .</p><p>Those are all Platform as a Service (PaaS) services.</p><p>Then came the IaaS wave, offering more control and being less opinionated about how we should expose &amp; manage cloud assets.&nbsp; With it we could replicate in large parts an on premise environment.&nbsp; First came Virtual Machines, then Virtual Networks (akin to on premise VLANs), then <a href="https://vincentlauzon.com/2015/12/21/using-network-security-groups-nsg-to-secure-network-access-to-an-environment/">Network Security Groups</a> (akin to on premise Firewall rules), then Virtual Network Appliances (literally a software version of an on premise Firewall), etc.&nbsp; .</p><p>Enterprises love this IaaS as it allows to more quickly migrate assets to the cloud since they can more easily adapt their governance model.</p><p>But Enterprises, like all Cloud users, realize that the best TCO is in PaaS services.</p><p>This is where the two models collided.</p><p>After we spent all this effort stonewalling our VMs within a Virtual Network, implementing access rules, e.g. inbound PORT 80 connections can only come from on premise users through the VPN Gateway, we were going to access the Azure SQL Database through a public endpoint?</p><p>That didn’t go down easily.</p><p>Azure SQL DB specifically has an integrated firewall.&nbsp; We can block all access, leave only IP ranges (again good for connection over the internet) or leave “Azure connections”.&nbsp; The last one look more secure as no one from an hotel room (or a bed in New Jersey) could access the database.&nbsp; But anyone within Azure, <strong>anyone</strong>, could still access it.</p><p>The kind of default architecture was something like this:</p><p><a href="assets/2017/10/vnet-service-endpoints-for-azure-sql-storage/image6.png"><img title="image" style="border:0 currentcolor;border-image:none;display:inline;background-image:none;" alt="image" src="assets/2017/10/vnet-service-endpoints-for-azure-sql-storage/image_thumb6.png" border="0" /></a></p><p>This did put a lot of friction to the adoption of PaaS services by Enterprise customers.</p><h2>The solution until now</h2><p>The previous diagram is a somewhat naïve deployment and we could do better.&nbsp; A lot of production deployments are like this though.</p><p>We could do better by controlling the access via incoming IP addresses.&nbsp; Outbound connections from a VM come through a Public IP.&nbsp; We could filter access given that IP within the PaaS Service integrated Firewall.</p><p>In order to do that, we needed a static public IP though.&nbsp; Dynamic IP preserves their domain name but they aren’t guaranteed to preserve their underlying IP value.</p><p><a href="assets/2017/10/vnet-service-endpoints-for-azure-sql-storage/image7.png"><img title="image" style="border:0 currentcolor;border-image:none;display:inline;background-image:none;" alt="image" src="assets/2017/10/vnet-service-endpoints-for-azure-sql-storage/image_thumb7.png" border="0" /></a></p><p>This solution had several disadvantages:</p><ul><li>It requires a different paradigm (public IP filtering vs VNET / NSGs) to secure access</li><li>It requires static IPs</li><li>If the VMs were not meant to be exposed on the internet, it adds on configuration and triggers some security questions during reviews</li><li>A lot of deployment included a “force tunneling” to the on premise firewall for internet access ; since the Azure SQL DB technically is on the internet, traffic was routed on premise, increasing latency substantially</li></ul><p>And this is where we were at until this week when VNET Service Endpoints were announced at <a href="https://www.microsoft.com/en-us/ignite/" target="_blank">Microsoft Ignite</a>.</p><h2>The solution</h2><p>The ideal solution would be to instantiate the PaaS service within a VNET.&nbsp; For a lot of PaaS services, given their multi-tenant nature, it is impossible to do.</p><p>That is the approach taken by a lot of single-tenant PaaS services though, e.g. <a href="https://vincentlauzon.com/2016/01/26/network-access-control-on-an-hdinsight-cluster/">HD Insights</a>, <a href="https://vincentlauzon.com/2017/07/17/azure-application-gateway-anatomy/" target="_blank">Application Gateway</a>, Redis Cache, etc.&nbsp; .</p><p>For multi-tenant PaaS where the communication is always outbound to the Azure service (i.e. the service doesn’t initiate a connection to our VMs), the solution going forward is VNET Service Endpoints.</p><p>At the time of this writing, only Azure Storage, Azure SQL DB &amp; Azure SQL Data Warehouse do support that mechanisms.&nbsp; Other PaaS services are planned to support it in the future.</p><p>VNET Service Endpoints does the next best thing to instantiating the PaaS service in our VNET.&nbsp; It allows us to filter connections according to the VNET / Subnet of the source.</p><p>This is made possible by a fundamental change in the Azure Network Stack.&nbsp; VNETs now have identities that can be carried with a connection.</p><p>So we are back to where we wanted to be:</p><p><a href="assets/2017/10/vnet-service-endpoints-for-azure-sql-storage/image8.png"><img title="image" style="border:0 currentcolor;border-image:none;display:inline;background-image:none;" alt="image" src="assets/2017/10/vnet-service-endpoints-for-azure-sql-storage/image_thumb8.png" border="0" /></a></p><p>The solution isn’t perfect.&nbsp; For instance, it doesn’t allow to filter for connections coming from on premise computers via a VPN Gateway:&nbsp; the connection needs to be initiated from the VNET itself for VNET Service Endpoints to work.</p><p>Also, the access to PaaS resources is still done via the PaaS public IP so the VNET must allow connection to the internet.&nbsp; This is mitigated by <a href="https://docs.microsoft.com/en-ca/azure/virtual-network/security-overview#service-tags" target="_blank">new tags allowing to target some specific PaaS</a> ; for instance, we could allow traffic going only to Azure SQL DBs (although not our Azure SQL DB instance only).</p><p>The connection does bypass “force tunneling” though and therefore the traffic stays on the Microsoft Network thus improving latency.</p><h2>Summary</h2><p>VNET Service Endpoints allow to secure access to PaaS services such as Azure SQL DB, Azure SQL Data Warehouse &amp; Azure Storage (and soon more).</p><p>It offers something close to bringing the PaaS services to our VNET.</p>